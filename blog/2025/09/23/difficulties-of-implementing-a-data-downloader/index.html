
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://laiyk5.github.io/stock-racetrack/blog/2025/09/23/difficulties-of-implementing-a-data-downloader/">
      
      
      
        <link rel="next" href="../../28/pyramid-strategy/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Difficulties of Implementing a Data Downloader - Stock RaceTrack</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Difficulties of Implementing a Data Downloader - Stock RaceTrack" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://laiyk5.github.io/stock-racetrack/assets/images/social/blog/posts/downloader.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://laiyk5.github.io/stock-racetrack/blog/2025/09/23/difficulties-of-implementing-a-data-downloader/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Difficulties of Implementing a Data Downloader - Stock RaceTrack" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://laiyk5.github.io/stock-racetrack/assets/images/social/blog/posts/downloader.png" >
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#difficulties-of-implementing-a-data-downloader" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Stock RaceTrack" class="md-header__button md-logo" aria-label="Stock RaceTrack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Stock RaceTrack
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Difficulties of Implementing a Data Downloader
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Stock RaceTrack" class="md-nav__button md-logo" aria-label="Stock RaceTrack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Stock RaceTrack
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stock RaceTrack
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    September 2025
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/research/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Research
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nature-of-web-based-api" class="md-nav__link">
    <span class="md-ellipsis">
      Nature of Web-based API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nature-of-stock-data-api" class="md-nav__link">
    <span class="md-ellipsis">
      Nature of Stock Data API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variety-of-data-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Variety of data schema
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-abuse-meaning-less-request" class="md-nav__link">
    <span class="md-ellipsis">
      API abuse: Meaning less request
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API abuse: Meaning less request">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solution-1-brute-force" class="md-nav__link">
    <span class="md-ellipsis">
      Solution 1: brute force
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution-2-fine-grianed-control" class="md-nav__link">
    <span class="md-ellipsis">
      Solution 2: fine grianed control
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Solution 2: fine grianed control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracking-the-missing-data" class="md-nav__link">
    <span class="md-ellipsis">
      Tracking the missing data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-merging-direction" class="md-nav__link">
    <span class="md-ellipsis">
      The merging direction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#known-missing-data" class="md-nav__link">
    <span class="md-ellipsis">
      Known missing data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2025-09-23 00:00:00+00:00" class="md-ellipsis">September 23, 2025</time>
                      </div>
                    </li>
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 13h1.5v2.82l2.44 1.41-.75 1.3L15 16.69zm4-5H5v11h4.67c-.43-.91-.67-1.93-.67-3a7 7 0 0 1 7-7c1.07 0 2.09.24 3 .67zM5 21a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1V1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v6.1c1.24 1.26 2 2.99 2 4.9a7 7 0 0 1-7 7c-1.91 0-3.64-.76-4.9-2zm11-9.85A4.85 4.85 0 0 0 11.15 16c0 2.68 2.17 4.85 4.85 4.85A4.85 4.85 0 0 0 20.85 16c0-2.68-2.17-4.85-4.85-4.85"/></svg>
                          <time datetime="2025-09-24 00:00:00+00:00" class="md-ellipsis">September 24, 2025</time>
                        </div>
                      </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/data/">Data</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              4 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  




<h1 id="difficulties-of-implementing-a-data-downloader">Difficulties of Implementing a Data Downloader</h1>
<p>HTTP based APIs (like Tushare and AKshare) are very convenient, but when it comes to stock research, backtesting or auto-trading, they have some fatal drawbacks:</p>
<ol>
<li>Network delay: the network delay would accumulate to an unacceptable level when the computation involves many queries.</li>
<li>API limitation: most of the public data API endpoint has a low limitation of fetching data.</li>
</ol>
<p>To overcome these difficulties, one solution is to "cached" them in your private database.</p>
<!-- more -->

<h2 id="nature-of-web-based-api">Nature of Web-based API</h2>
<p>The nature of all APIs are:</p>
<ol>
<li>Long RTT(round-trip-time)</li>
<li>Low request frequency</li>
<li>
<p>Limited records returned</p>
</li>
<li>
<p>To overcome 1, the solution is parallelization and cache.</p>
</li>
<li>To overcome 2, the solution would be batch and cache.</li>
<li>To overcome 3, we use batch with limited size.</li>
</ol>
<h2 id="nature-of-stock-data-api">Nature of Stock Data API</h2>
<p>Most Stock data APIs can be categorized as:</p>
<table>
<thead>
<tr>
<th>API params \ Data indexed by</th>
<th><strong>symbol &amp; timestamp</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>symbol or timestamp</strong></td>
<td>depending on the size of the data</td>
</tr>
<tr>
<td><strong>symbols(s)</strong></td>
<td>by symbol</td>
</tr>
<tr>
<td><strong>timestamp / timerange</strong></td>
<td>by timerange</td>
</tr>
</tbody>
</table>
<p>So Stock Data API can be defined as:</p>
<pre><code class="language-python">class API:
{
  &quot;biz_key&quot;: &quot;tushare_daily&quot;
  &quot;fetch_methods&quot;: {
    &quot;by_time&quot;: by_time # None | Callable[str, start, end]
    &quot;by_symbol&quot;: by_symbol # None | Callable[list[str], start, end]
  },
  &quot;limit&quot;: {
    &quot;qps&quot;: 10 # query per second, int
    &quot;rpq&quot;: 6000 # response per query, int
  },
  &quot;frequency&quot;: timedelta(1) # frequencies of time.
}
</code></pre>
<h2 id="variety-of-data-schema">Variety of data schema</h2>
<p>For stock data, there're so many data endpoints with so many different schemas. It's not realistic to replicate such amount of APIs.
But we can directly store each data record as a json object to decouple the fetching and preprocessing stage.</p>
<p>Most of the stock data types are indexed by two dimension: time and symbol. The symbol can be stock, fund, index or something else.</p>
<p>So each record in the table would be:</p>
<p>(biz_key, symbol, timestamp, data) or
(biz_key, symbol, timerange, data)</p>
<p>timestamp can be represented by timerange as long as we state that the left endpoint of the
timerange is the timestamp to be represented, so record in the table could be:</p>
<pre><code class="language-python">record = (biz_key, symbol, timerange, data)
</code></pre>
<p>, where <code>biz_key</code> is the identifier of the API.</p>
<p>With this schema, we can adapt to many different API of many different data providers easily.</p>
<h2 id="api-abuse-meaning-less-request">API abuse: Meaning less request</h2>
<p>The data request is usually like this:</p>
<pre><code class="language-python">request = (biz_key, symbol_set, timerange)
</code></pre>
<p>But when most of the data in the request is already fetched,
fetching all data specified by the request would be wasteful.</p>
<p>What's more, the underlying API might be frequency limited or returning record limited,
which further complicates the problem.</p>
<h3 id="solution-1-brute-force">Solution 1: brute force</h3>
<p>We assume that the data provider can provide both fetch-by-time and fetch-by-symbol methods,
the size of the whole dataset is acceptable for both storage and time to fetch. Then we just need
to:</p>
<ol>
<li>assume that all presented symbol is up-to-date for the last update time</li>
<li>and just fetch full history of those missing symbols till the last update time</li>
<li>and finally fetch all data from last update time to now by time.</li>
</ol>
<h3 id="solution-2-fine-grianed-control">Solution 2: fine grianed control</h3>
<p>Remember our purpose: we want to avoid abusing the API. So the target is not
to avoid all meaningless request, but try to cut as more meaningless request as possible.</p>
<p>To avoid abusing the API, the solution is merging the underlying data request.
But before we can merge the data requests, we have to find them out first.</p>
<h4 id="tracking-the-missing-data">Tracking the missing data</h4>
<p>One solution is, for each <code>(biz_key, symbol)</code>, maintaining a table <code>raw_data_coverage</code> recording the
data fetched during <code>timerange</code>. Every time we bulk write the <code>raw_data</code> table, we also bulk request
and update <code>raw_data_ccoverage</code>. And every time we update the table, we spend <code>O(S)</code> time to calculate
the indexes of missing records, where <code>S</code> is the size of the symbol set given.</p>
<p>There're some corner stage. Some data is missing because of its nature: the market is close on that day, the
company is unlisted, not listed, suspended and so on. So the calculated set is a superset of the
missing data. The analyze and solution can be found <a href="#known-missing-data">below</a></p>
<h4 id="the-merging-direction">The merging direction</h4>
<p>Different API suits different merging direction. If the API is a crawler that craw detail page of a specific
symbol, then we should merge in the time direction; if the API can provide a fetch several symbols in batch,
then merging in the symbol direction is also a good choice. As long as the stride is under the limit specified
by the API, merge all requests.</p>
<p>But which are better? My solution is: take both and compare. The complexity is just <code>O(T) + O(S)</code>.
So the computing costs is much lower then the <code>O(TS)</code> fetching costs.</p>
<p>One corner case is that the missing data is distributed evenly. This would trigger a fetch of all existing data.
But since the request is both symbol locally and time locally, this case would be rare.</p>
<h4 id="known-missing-data">Known missing data</h4>
<p>Some data does not exists in the certain time range. If we ignore this nature of the stock data, we will end up
with a fragmented <code>raw_data_coverage</code> table. Until now, the semantic of the coverage table is: the time range the
data covered. But to avoid fragmentation, and to make the table better serve the purpose of avoid duplicate API calls, let us shift the semantic to "the time range that do not fetch again".</p>
<p>But how/when to declare these time ranges? There're two approaches, a strict approach and a lapse approach. If
we take the strict approach, we need a trustful source that tell us that which ranges are not covered. If we take the lapse approach, we just simply black out all those we have tried, and those return an empty data.</p>
<p>The later one is more pratical: if no data is returned, just assume the data does not exists. Data in the past
logically will not be updated in the future. So missing data is always missing.</p>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": [], "search": "../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>